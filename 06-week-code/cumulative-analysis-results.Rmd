This is a document for us to compile all significant findings from our research this summer.

# libraries
```{r}
library(forcats)
library(haven)
library(readxl)
library(ggplot2)
library(tidyverse)
library(dplyr)
library(janitor)
library(magrittr)
library(ggcorrplot)
library(viridis)
library(haven)
library(lme4)
library(lmerTest)
library(nlme)
```

##data
```{r}
pls <- readRDS("../data/pls_long_rank.dta")
bit_mother <- readRDS("../data/BIT_long_mother.dta")
bit_father <- readRDS("../data/BIT_long_father.dta")
bit <- readRDS("../data/BIT_long_par.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")
#hhincome, pargen, childid, parid
background <- read_dta("../data/wave-1-(9-mo)/2_BCK_w1.dta")
demographic_background <- read_dta("../data/wave-1-(9-mo)/1_DEM_w1.dta")

bit<- bit %>% 
  mutate( wave = case_when(
    wave == "2" ~ "Wave 1",
    wave == "5" ~ "Wave 4",
    wave == "6" ~ "Wave 6"),
    wave = as.factor(wave)) %>% 
  subset(!is.nan(BITcompavg), !is.nan(BITprobavg)) %>% 
  transmute(child_id, wave, BITcompavg, BITprobavg)

bg_income <- background %>% 
  zap_labels() %>% 
  transmute(par_id = as.character(parid),
            child_id = as.character(childid),
            hhincome = as.numeric(hhincome),
            household_income = hhincome/1000,
            father = as.logical(pargen))

bg_age <- demographic_background %>% 
  zap_labels() %>% 
  transmute(par_id = as.character(parid),
            child_id = as.character(childid),
            parent_age = as.numeric(parage),
            father = as.logical(pargen))


# if hhincome isn't a good predictor let's include bill_difficulty
demo <- demo %>% 
   transmute(par_id, 
             child_id, 
             bill_difficulty = as.factor(bill_difficulty),
             marital_status = as.factor(marital_status),
             assistance,
             father,
             par_us_born,
             highest_degree_completed,
             span_lang_form)

grouping <- grouping %>% 
  mutate(treatment = case_when(
    condition == "4" ~ " - control",
    condition == "1" ~ " - mom",
    condition == "2" ~ " - dad",
    condition == "3" ~ " - both"),
    treatment = fct_relevel(
      treatment,
      " - control",
      " - mom",
      " - dad",
      " - both"),
    control = ifelse(condition == "4", TRUE, FALSE))

pls <- pls %>%
  zap_labels() %>% 
  mutate(par_id = as.character(par_id),
         child_id = as.character(child_id))
 

media_pls <- media %>%
  full_join(bit, by = c("child_id", "wave")) %>% 
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(grouping, by = c("child_id")) %>%
  inner_join(demo, by = c("child_id", "par_id")) %>% 
  inner_join(bg_age, by = c("child_id", "par_id")) %>% 
  inner_join(bg_income, by = c("child_id", "par_id")) %>% 
  mutate(wave = as.factor(wave)) #%>% 
  #inner_join(bit_updated, by = c("child_id"))

media_pls_mother <- media %>%
  full_join(bit, by = c("child_id", "wave")) %>% 
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(grouping, by = c("child_id")) %>%
  inner_join(demo, by = c("child_id", "par_id")) %>%
  inner_join(bg_age, by = c("child_id", "par_id")) %>% 
  inner_join(bg_income, by = c("child_id", "par_id")) %>% 
  filter(par_id < 30000)

media_pls_father <- media %>%
  full_join(bit, by = c("child_id", "wave")) %>% 
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(grouping, by = c("child_id")) %>%
  inner_join(demo, by = c("child_id", "par_id")) %>%
  inner_join(bg_age, by = c("child_id", "par_id")) %>% 
  inner_join(bg_income, by = c("child_id", "par_id")) %>% 
  filter(par_id >= 30000)

media_pls <- media_pls %>% 
  mutate(
    treatment = case_when(
    condition == "4" ~ " Control",
    condition == "1" ~ " Mom",
    condition == "2" ~ " Dad",
    condition == "3" ~ " Both"),
    treatment = fct_relevel(
      treatment,
      " Control",
      " Mom",
      " Dad",
      " Both"),
    wave = case_when(
    wave == "1" ~ "Wave 1",
    wave == "4" ~ "Wave 4",
    wave == "6" ~ "Wave 6"),
    wave = fct_relevel(
      wave,
      "Wave 1",
      "Wave 4",
      "Wave 6"))

media_pls1 <- media_pls %>% 
  select(plspr, behavior_management, father,wave, treatment , par_age, years_school_complete, span_lang_form, child_id) %>% 
  na.omit()
```


#final lmer model
```{r}
model <- media_pls1 %>% 
  lmer(plspr ~ behavior_management+ father+wave+ treatment + par_age+ years_school_complete+ span_lang_form+ (1 | child_id), REML = FALSE, data = .)

summary(model)
```
Explanation:

# Checking final lmer model assumptions
```{r}

```
Explanation:

##notable lmers from the data
```{r}

```
Explanation:

##cross-lagged associations using lm
```{r}

```
Explanation:

#significant ANOVA model
```{r}
pl_cond_w <- aov(plspr ~ treatment + wave + treatment:wave, media_pls)
summary(pl_cond_w)

tukey.test <- TukeyHSD(pl_cond_w)
plot(tukey.test)


TukeyHSD(pl_cond_w)
```
Explanation:

##notable ANOVA models
```{r}

```
Explanation:

# main data visualizations
```{r}
library(MuMIn)
MuMIn::r.squaredGLMM(model)
media_pls1 %>%
#  mutate(pred = predict(model, newdata = media_pls)) %>%
  ggplot(aes(plspr, predict(model, newdata = media_pls1))) +
  geom_point() +
  geom_abline(intercept = 0,
              slope = 1,
              col = "salmon") +  
  scale_y_continuous(expand=c(0,0), limits = c(0, 100))+
  scale_x_continuous(expand=c(0,0), limits = c(0, 100))+
  theme_bw()+
  labs(y = "Acutal Total PLS Percentile Rank",
       x = "Predicted Total PLS Percentile Rank",
       title = "Actual vs Predicted PLS Percentile Rank",
       caption = "Correlation: 0.819")

cor(media_pls1$plspr, predict(model, newdata = media_pls1))

library(equatiomatic)
```
Explanation:

```{r}
#hardly any difference b/w mothers and fathers (could test anova but the graph is pretty telling)
g <- media_pls %>%
  ggplot( aes(behavior_management, plspr)) +
  geom_point(aes(color = behavior_management)) +
  geom_smooth(method = "lm", color = "grey", size=0.7, se=FALSE) + 
  facet_grid(treatment~wave) +
  scale_color_viridis(option = "D") +
  xlab("Media as Behavior Management Frequency") +
  ylab("Infant Communication Skills") +
  theme_minimal() +
  ggtitle("Infant Communication Skills and Media as Behavior Management Across Waves")

g + theme(legend.position="none")
```
Explanation:

## notable data visualizations
```{r}

```

