```{r}
library(tidyverse)
library(haven)
library(lme4)
library(lmerTest)
library(nlme)
```


# Model Improvement Explorations

## base (null) model
```{r}
pls_mother <- readRDS("../data/PLS_long_mother.dta")
pls_father <- readRDS("../data/PLS_long_father.dta")
media <- readRDS("../data/media_long.dta")


# clean data
pls <- pls_mother %>%
  full_join(pls_father) %>%
  mutate(wave = as.factor(wave),
         total_score = ifelse(total_score < 0, NA, total_score)) %>% 
  select(par_id, child_id, wave, total_score)

media <- media %>% 
  mutate(wave = as.factor(wave),
         daily_use = ifelse(daily_use < 0, NA, daily_use)) %>% 
  select(par_id, child_id, wave, daily_use)

media_pls <- media %>%
  full_join(pls, by = c("par_id", "child_id", "wave"))

model_0 <- lmer(total_score ~ daily_use * wave + (1 + daily_use | child_id), data = media_pls, REML = FALSE)

summary(model)

# create data set without NA values to be used for predictions
media_pred <- media_pls %>%
  filter(!is.na(daily_use) & !is.na(total_score))

# graph actual vs predicted
media_pred %>%
  mutate(pred = predict(model, newdata = media_pred)) %>%
  ggplot(aes(total_score, predict(model, newdata = media_pred))) +
  geom_point() +
  geom_abline(intercept = 0,
              slope = 1,
              col = "salmon") +
  labs(x = "Acutal Total PLS Score",
       y = "Predicted Total PLS Score",
       title = "Actual vs Predicted PLS Scores")

cor(media_pred$total_score, predict(model, newdata = media_pred))
```

## add parenting class taken as covariate

```{r}
pls_mother <- readRDS("../data/PLS_long_mother.dta")
pls_father <- readRDS("../data/PLS_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")


# clean data
pls <- pls_mother %>%
  full_join(pls_father) %>%
  mutate(wave = as.factor(wave),
         total_score = ifelse(total_score < 0, NA, total_score)) %>% 
  select(par_id, child_id, wave, total_score)

media <- media %>% 
  mutate(wave = as.factor(wave),
         daily_use = ifelse(daily_use < 0, NA, daily_use)) %>% 
  select(par_id, child_id, wave, daily_use)

demo <- demo %>%
  select(par_id, child_id, parenting_class_taken)

media_pls <- media %>%
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(demo, by = c("par_id", "child_id"))

model <- lmer(total_score ~ parenting_class_taken + daily_use * wave + (1 + daily_use | child_id), data = media_pls)

summary(model)

# create data set without NA values to be used for predictions
media_pred <- media_pls %>%
  filter(!is.na(daily_use) & !is.na(total_score))

# graph actual vs predicted
media_pred %>%
  mutate(pred = predict(model, newdata = media_pred)) %>%
  ggplot(aes(total_score, predict(model, newdata = media_pred))) +
  geom_point() +
  geom_abline(intercept = 0,
              slope = 1,
              col = "salmon") +
  labs(x = "Acutal Total PLS Score",
       y = "Predicted Total PLS Score",
       title = "Actual vs Predicted PLS Scores")
```
## add years school complete as covariate - lowest p-value

```{r}
pls_mother <- readRDS("../data/PLS_long_mother.dta")
pls_father <- readRDS("../data/PLS_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")


# clean data
pls <- pls_mother %>%
  full_join(pls_father) %>%
  mutate(wave = as.factor(wave),
         total_score = ifelse(total_score < 0, NA, total_score)) %>% 
  select(par_id, child_id, wave, total_score)

media <- media %>% 
  mutate(wave = as.factor(wave),
         daily_use = ifelse(daily_use < 0, NA, daily_use)) %>% 
  select(par_id, child_id, wave, daily_use)

demo <- demo %>%
  select(par_id, child_id, years_school_complete)

media_pls <- media %>%
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(demo, by = c("par_id", "child_id"))

model <- lmer(total_score ~ years_school_complete + daily_use * wave + (1 + daily_use | child_id), data = media_pls, REML = FALSE)

summary(model)

# create data set without NA values to be used for predictions
media_pred <- media_pls %>%
  filter(!is.na(daily_use), !is.na(total_score), !is.na(years_school_complete))

# graph actual vs predicted
media_pred %>%
  mutate(pred = predict(model, newdata = media_pred)) %>%
  ggplot(aes(total_score, predict(model, newdata = media_pred))) +
  geom_point() +
  geom_abline(intercept = 0,
              slope = 1,
              col = "salmon") +
  labs(x = "Acutal Total PLS Score",
       y = "Predicted Total PLS Score",
       title = "Actual vs Predicted PLS Scores")

cor(media_pred$total_score, predict(model, newdata = media_pred))
```

## add years school complete and parenting class taken as covariates

```{r}
pls_mother <- readRDS("../data/PLS_long_mother.dta")
pls_father <- readRDS("../data/PLS_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")


# clean data
pls <- pls_mother %>%
  full_join(pls_father) %>%
  mutate(wave = as.factor(wave),
         total_score = ifelse(total_score < 0, NA, total_score)) %>% 
  select(par_id, child_id, wave, total_score)

media <- media %>% 
  mutate(wave = as.factor(wave),
         daily_use = ifelse(daily_use < 0, NA, daily_use)) %>% 
  select(par_id, child_id, wave, daily_use)

demo <- demo %>%
  select(par_id, child_id, years_school_complete, parenting_class_taken)

media_pls <- media %>%
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(demo, by = c("par_id", "child_id"))

model <- lmer(total_score ~ 
                # fixed effects
                years_school_complete + 
                parenting_class_taken + 
                # interaction term
                daily_use * wave + 
                # random effects
                (1 + daily_use | child_id), data = media_pls)

summary(model)

# create data set without NA values to be used for predictions
media_pred <- media_pls %>%
  filter(!is.na(daily_use), !is.na(total_score), !is.na(years_school_complete))

# graph actual vs predicted
media_pred %>%
  mutate(pred = predict(model, newdata = media_pred)) %>%
  ggplot(aes(total_score, predict(model, newdata = media_pred))) +
  geom_point() +
  geom_abline(intercept = 0,
              slope = 1,
              col = "salmon") +
  labs(x = "Acutal Total PLS Score",
       y = "Predicted Total PLS Score",
       title = "Actual vs Predicted PLS Scores")
```

## add household income level as covariate

```{r}
pls_mother <- readRDS("../data/PLS_long_mother.dta")
pls_father <- readRDS("../data/PLS_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")


# clean data
pls <- pls_mother %>%
  full_join(pls_father) %>%
  mutate(wave = as.factor(wave),
         total_score = ifelse(total_score < 0, NA, total_score)) %>% 
  select(par_id, child_id, wave, total_score)

media <- media %>% 
  mutate(wave = as.factor(wave),
         daily_use = ifelse(daily_use < 0, NA, daily_use)) %>% 
  select(par_id, child_id, wave, daily_use)

demo <- demo %>%
  select(par_id, child_id, household_income_numerical)

media_pls <- media %>%
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(demo, by = c("par_id", "child_id"))

model <- lmer(total_score ~ household_income_numerical + daily_use * wave + (1 + daily_use | child_id), data = media_pls)

summary(model)

# create data set without NA values to be used for predictions
media_pred <- media_pls %>%
  filter(!is.na(daily_use), !is.na(total_score), !is.na(household_income_numerical))

# graph actual vs predicted
media_pred %>%
  mutate(pred = predict(model, newdata = media_pred)) %>%
  ggplot(aes(total_score, predict(model, newdata = media_pred))) +
  geom_point() +
  geom_abline(intercept = 0,
              slope = 1,
              col = "salmon") +
  labs(x = "Acutal Total PLS Score",
       y = "Predicted Total PLS Score",
       title = "Actual vs Predicted PLS Scores")
```


## add household income and highest degree earned as covariates
```{r}
pls_mother <- readRDS("../data/PLS_long_mother.dta")
pls_father <- readRDS("../data/PLS_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")


# clean data
pls <- pls_mother %>%
  full_join(pls_father) %>%
  mutate(wave = as.factor(wave),
         total_score = ifelse(total_score < 0, NA, total_score)) %>% 
  select(par_id, child_id, wave, total_score)

media <- media %>% 
  mutate(wave = as.factor(wave),
         daily_use = ifelse(daily_use < 0, NA, daily_use)) %>% 
  select(par_id, child_id, wave, daily_use)

demo <- demo %>%
  select(par_id, child_id, years_school_complete, household_income_numerical)

media_pls <- media %>%
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(demo, by = c("par_id", "child_id"))

model <- lmer(total_score ~ 
                # fixed effects
                years_school_complete + 
                household_income_numerical + 
                # interaction term
                daily_use * wave + 
                # random effects
                (1 + daily_use | child_id), data = media_pls)

summary(model)

# create data set without NA values to be used for predictions
media_pred <- media_pls %>%
  filter(!is.na(daily_use), !is.na(total_score), !is.na(years_school_complete), !is.na(household_income_numerical))

# graph actual vs predicted
media_pred %>%
  mutate(pred = predict(model, newdata = media_pred)) %>%
  ggplot(aes(total_score, predict(model, newdata = media_pred))) +
  geom_point() +
  geom_abline(intercept = 0,
              slope = 1,
              col = "salmon") +
  labs(x = "Acutal Total PLS Score",
       y = "Predicted Total PLS Score",
       title = "Actual vs Predicted PLS Scores")
```
## Aubree's original model

```{r}
pls <- readRDS("../data/PLS_long_mother.dta")
media <- readRDS("../data/media_long.dta")

colSums(is.na(pls))
colSums(is.na(media))

pls <- pls %>% 
  mutate(wave = as.factor(wave),
         total_score = ifelse(total_score < 0, NA, total_score)) %>% 
  select(par_id, child_id, wave, total_score)

media <- media %>% 
  mutate(wave = as.factor(wave),
         daily_use = ifelse(daily_use < 0, NA, daily_use)) %>% 
  select(par_id, child_id, wave, daily_use) %>%
  filter(par_id < 30000, wave != 4)


media_pls <- media %>%
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  select(par_id, child_id, daily_use, total_score, wave) %>%
  na.omit()


model <- lmer(total_score ~ daily_use * wave + (1 | child_id), data = media_pls, REML = FALSE)

summary(model)

# graph actual vs predicted
media_pls %>%
  mutate(pred = predict(model, newdata = media_pls)) %>%
  ggplot(aes(total_score, predict(model, newdata = media_pls))) +
  geom_point() +
  geom_abline(intercept = 0,
              slope = 1,
              col = "salmon") +
  labs(x = "Acutal Total PLS Score",
       y = "Predicted Total PLS Score",
       title = "Actual vs Predicted PLS Scores")

cor(media_pls$total_score, predict(model, newdata = media_pls))

```


## Model exploration after meeting

```{r}
pls_mother <- readRDS("../data/PLS_long_mother.dta")
pls_father <- readRDS("../data/PLS_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")


# clean data
pls <- pls_mother %>%
  full_join(pls_father) %>%
  mutate(wave = as.factor(wave),
         total_score = ifelse(total_score < 0, NA, total_score)) %>% 
  select(par_id, child_id, wave, total_score)

media <- media %>% 
  mutate(wave = as.factor(wave),
         daily_use = ifelse(daily_use < 0, NA, daily_use)) %>% 
  select(par_id, child_id, wave, daily_use)

demo <- demo %>%
  select(par_id, child_id, years_school_complete, household_income_numerical)

media_pls <- media %>%
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(demo, by = c("par_id", "child_id")) %>%
  inner_join(grouping, by = c("child_id")) %>%
  mutate(sex = case_when(
    par_id >= 30000 ~ "m",
    par_id < 30000 ~ "f"
  ))

model <- lmer(total_score ~ 
                # fixed effects
                years_school_complete + 
                household_income_numerical + 
                condition +
                sex +
                # interaction term
                daily_use * wave + 
                daily_use * sex +
                # random effects
                (1 | child_id), data = media_pls)

summary(model)

# create data set without NA values to be used for predictions
media_pred <- media_pls %>%
  filter(!is.na(daily_use), !is.na(total_score), !is.na(years_school_complete), !is.na(household_income_numerical))

# graph actual vs predicted
media_pred %>%
  mutate(pred = predict(model, newdata = media_pred)) %>%
  ggplot(aes(total_score, predict(model, newdata = media_pred))) +
  geom_point() +
  geom_abline(intercept = 0,
              slope = 1,
              col = "salmon") +
  labs(x = "Acutal Total PLS Score",
       y = "Predicted Total PLS Score",
       title = "Actual vs Predicted PLS Scores")
```
## BIT ~ behavior & mealtimes

### probavg ~ mealtimes .

```{r}
bit_mother <- readRDS("../data/BIT_long_mother.dta")
bit_father <- readRDS("../data/BIT_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")

bit_media <- bit_mother %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_mother, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>% 
  inner_join(grouping, by = "child_id")

bit_media_father <- bit_father %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_father, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>%
  inner_join(grouping, by = "child_id")

model <- lmer(BITprobavg ~ mealtimes * wave + condition + (1 | child_id), data = bit_media, REML = FALSE)

summary(model)
```

### probavg ~ behavior .

```{r}
bit_mother <- readRDS("../data/BIT_long_mother.dta")
bit_father <- readRDS("../data/BIT_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")

bit_media <- bit_mother %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_mother, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>% 
  inner_join(grouping, by = "child_id")

bit_media_father <- bit_father %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_father, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>%
  inner_join(grouping, by = "child_id")

model <- lmer(BITprobavg ~ behavior_management * wave + condition + (1 | child_id), data = bit_media, REML = FALSE)

summary(model)
```

### compavg ~ mealtimes

```{r}
bit_mother <- readRDS("../data/BIT_long_mother.dta")
bit_father <- readRDS("../data/BIT_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")

bit_media <- bit_mother %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_mother, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>% 
  inner_join(grouping, by = "child_id")

bit_media_father <- bit_father %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_father, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>%
  inner_join(grouping, by = "child_id")

model <- lmer(BITcompavg ~ mealtimes * wave + condition + (1 | child_id), data = bit_media, REML = FALSE)

summary(model)
```

### compavg ~ behavior

```{r}
bit_mother <- readRDS("../data/BIT_long_mother.dta")
bit_father <- readRDS("../data/BIT_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")

bit_media <- bit_mother %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_mother, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>% 
  inner_join(grouping, by = "child_id")

bit_media_father <- bit_father %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_father, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>%
  inner_join(grouping, by = "child_id")

model <- lmer(BITcompavg ~ behavior_management * wave + condition + (1 | child_id), data = bit_media, REML = FALSE)

summary(model)
```

## mealtimes ~ BIT

### mealtimes ~ probavg *

```{r}
bit_mother <- readRDS("../data/BIT_long_mother.dta")
bit_father <- readRDS("../data/BIT_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")

bit_media <- bit_mother %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_mother, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>% 
  inner_join(grouping, by = "child_id")

bit_media_father <- bit_father %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_father, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>%
  inner_join(grouping, by = "child_id")

model <- lmer(mealtimes ~ BITprobavg * wave + condition + (1 | child_id), data = bit_media, REML = FALSE)

summary(model)
```

### mealtimes ~ compavg

```{r}
bit_mother <- readRDS("../data/BIT_long_mother.dta")
bit_father <- readRDS("../data/BIT_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")

bit_media <- bit_mother %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_mother, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>% 
  inner_join(grouping, by = "child_id")

bit_media_father <- bit_father %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_father, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>%
  inner_join(grouping, by = "child_id")

model <- lmer(mealtimes ~ BITcompavg * wave + condition + (1 | child_id), data = bit_media, REML = FALSE)

summary(model)
```

## behavior ~ BIT

### behavior ~ probavg

```{r}
bit_mother <- readRDS("../data/BIT_long_mother.dta")
bit_father <- readRDS("../data/BIT_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")

bit_media <- bit_mother %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_mother, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>% 
  inner_join(grouping, by = "child_id")

bit_media_father <- bit_father %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_father, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>%
  inner_join(grouping, by = "child_id")

model <- lmer(behavior_management ~ BITprobavg * wave + condition + (1 | child_id), data = bit_media, REML = FALSE)

summary(model)
```

### behavior ~ compavg

```{r}
bit_mother <- readRDS("../data/BIT_long_mother.dta")
bit_father <- readRDS("../data/BIT_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")

bit_media <- bit_mother %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_mother, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>% 
  inner_join(grouping, by = "child_id")

bit_media_father <- bit_father %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_father, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>%
  inner_join(grouping, by = "child_id")

model <- lmer(behavior_management ~ BITcompavg * wave + condition + (1 | child_id), data = bit_media, REML = FALSE)

summary(model)
```

## Multiple comparisons

```{r}
bit_mother <- readRDS("../data/BIT_long_mother.dta")
bit_father <- readRDS("../data/BIT_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")

media_mother <- filter(media, par_id < 30000)
media_father <- filter(media, par_id >= 30000)

bit_media <- bit_mother %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_mother, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>% 
  inner_join(grouping, by = "child_id")

bit_media_father <- bit_father %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media_father, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>%
  inner_join(grouping, by = "child_id")
############################################
# run individual line for summary of model #
# lines with a . or a * has significant    #
# higher level variables (interactions)    #
############################################

# mother
# .
summary(lmer(BITprobavg ~ mealtimes * wave + condition + (1 | child_id), data = bit_media, REML = FALSE))
# .
summary(lmer(BITprobavg ~ behavior_management * wave + condition + (1 | child_id), data = bit_media, REML = FALSE))
summary(lmer(BITcompavg ~ mealtimes * wave + condition + (1 | child_id), data = bit_media, REML = FALSE))
summary(lmer(BITcompavg ~ behavior_management * wave + condition + (1 | child_id), data = bit_media, REML = FALSE))
# *
summary(lmer(mealtimes ~ BITprobavg + wave + condition + (1 | child_id), data = bit_media, REML = FALSE))
summary(lmer(mealtimes ~ BITcompavg * wave + condition + (1 | child_id), data = bit_media, REML = FALSE))
summary(lmer(behavior_management ~ BITprobavg * wave + condition + (1 | child_id), data = bit_media, REML = FALSE))
summary(lmer(behavior_management ~ BITcompavg * wave + condition + (1 | child_id), data = bit_media, REML = FALSE))

# father
summary(lmer(BITprobavg ~ mealtimes * wave + condition + (1 | child_id), data = bit_media_father, REML = FALSE))
summary(lmer(BITprobavg ~ behavior_management * wave + condition + (1 | child_id), data = bit_media_father, REML = FALSE))
summary(lmer(BITcompavg ~ mealtimes * wave + condition + (1 | child_id), data = bit_media_father, REML = FALSE))
summary(lmer(BITcompavg ~ behavior_management * wave + condition + (1 | child_id), data = bit_media_father, REML = FALSE))
summary(lmer(mealtimes ~ BITprobavg * wave + condition + (1 | child_id), data = bit_media_father, REML = FALSE))
# .
summary(lmer(mealtimes ~ BITcompavg * wave + condition + (1 | child_id), data = bit_media_father, REML = FALSE))
summary(lmer(behavior_management ~ BITprobavg * wave + condition + (1 | child_id), data = bit_media_father, REML = FALSE))
summary(lmer(behavior_management ~ BITcompavg * wave + condition + (1 | child_id), data = bit_media_father, REML = FALSE)) 

```

## Jame's threesome model

```{r}
bit_mother <- readRDS("../data/BIT_long_mother.dta")
bit_father <- readRDS("../data/BIT_long_father.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")
pls_mother <- readRDS("../data/PLS_long_mother.dta")

bit_media_pls <- bit_mother %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management) %>% 
  inner_join(grouping, by = "child_id") %>%
  inner_join(pls_mother, by = c("child_id", "wave"))

bit_media_father <- bit_father %>%
  mutate(wave = as.factor(case_when(
    wave == 2 ~ 1,
    wave == 5 ~ 4,
    wave == 6 ~ 6))) %>%
  full_join(media, by = c("par_id", "child_id", "wave")) %>% 
  select(child_id, wave, BITcompavg, BITprobavg, mealtimes, behavior_management)

model <- lmer(BITcompavg ~ total_score * wave + mealtimes * wave + (1 | child_id), data = bit_media_pls, REML = FALSE)

summary(model)
```

## Model exploration - new approach

```{r}
pls <- readRDS("../data/pls_long_rank.dta")
bit_mother <- readRDS("../data/BIT_long_mother.dta")
bit_father <- readRDS("../data/BIT_long_father.dta")
bit <- readRDS("../data/BIT_long_par.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")

glimpse(demo)
demo <- demo %>% 
  transmute(par_id, child_id, 
            bill_difficulty = as.factor(bill_difficulty),
            marital_status = as.factor(marital_status),
            assistance,
            father)

pls <- pls %>%
  mutate(par_id = as.character(par_id),
         child_id = as.character(child_id))

glimpse(media_pls)

media_pls <- media %>%
  full_join(bit, by = c("child_id", "wave")) %>% 
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(grouping, by = c("child_id")) %>%
  inner_join(demo, by = c("child_id", "par_id")) 

media_pls_mother <- media %>%
  full_join(bit, by = c("child_id", "wave")) %>% 
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(grouping, by = c("child_id")) %>%
  inner_join(demo, by = c("child_id", "par_id")) %>%
  filter(par_id < 30000)

media_pls_father <- media %>%
  full_join(bit, by = c("child_id", "wave")) %>% 
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(grouping, by = c("child_id")) %>%
  inner_join(demo, by = c("child_id", "par_id")) %>%
  filter(par_id >= 30000)
  

# base models

summary(model <- lmer(plspr ~ mealtimes + (1 | child_id), REML = FALSE, data = media_pls))
summary(model <- lmer(plsacpr ~ mealtimes + (1 | child_id), REML = FALSE, data = media_pls))
summary(model <- lmer(plsecpr ~ mealtimes + (1 | child_id), REML = FALSE, data = media_pls))
summary(model <- lmer(plspr ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls))
summary(model <- lmer(plsacpr ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls))
summary(model <- lmer(plsecpr ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls))

# bit models
summary(model <- lmer(BITprobavg ~ mealtimes + (1 | child_id), REML = FALSE, data = media_pls))
summary(model <- lmer(BITcompavg ~ mealtimes + (1 | child_id), REML = FALSE, data = media_pls))
summary(model <- lmer(BITprobavg ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls))
summary(model <- lmer(BITcompavg ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls))
summary(model <- lmer(BITprobavg ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls))
summary(model <- lmer(BITcompavg ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls))

# anova comparison # 0.241
model0 <- lmer(plspr ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls)
model1 <- lmer(plspr ~ behavior_management + condition + (1 | child_id), REML = FALSE, data = media_pls)

anova(model0, model1)

# anova comparison # 0.3548
model0 <- lmer(plspr ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls)
model1 <- lmer(plspr ~ behavior_management + condition * behavior_management + (1 | child_id), REML = FALSE, data = media_pls)

anova(model0, model1)

# anova comparison # 0.6779
model0 <- lmer(plspr ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls)
model1 <- lmer(plspr ~ behavior_management + condition : behavior_management + (1 | child_id), REML = FALSE, data = media_pls)

anova(model0, model1)

# anova comparison # 0.9331
model0 <- lmer(plspr ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls)
model1 <- lmer(plspr ~ behavior_management + condition : behavior_management + behavior_management : father + condition : father + (1 | child_id), REML = FALSE, data = media_pls)

anova(model0, model1)

# anova comparison # 2.2e-16 ############# adding wave
model0 <- lmer(plspr ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls)
model1 <- lmer(plspr ~ behavior_management + wave + (1 | child_id), REML = FALSE, data = media_pls_mother)
## adding condition # 0.3409
model1 <- lmer(plspr ~ behavior_management + wave + (1 | child_id), REML = FALSE, data = media_pls)
model2 <- lmer(plspr ~ behavior_management + wave + condition + (1 | child_id), REML = FALSE, data = media_pls)
## adding interaction wave:behavior ##### 0.007591
model1 <- lmer(plspr ~ behavior_management + wave + (1 | child_id), REML = FALSE, data = media_pls)
model2 <- lmer(plspr ~ behavior_management + wave + behavior_management:wave + (1 | child_id), REML = FALSE, data = media_pls)
## adding condition # 0.3257
model2 <- lmer(plspr ~ behavior_management + wave + behavior_management:wave + (1 | child_id), REML = FALSE, data = media_pls)
model3 <- lmer(plspr ~ behavior_management + wave + behavior_management:wave + condition + (1 | child_id), REML = FALSE, data = media_pls)

summary(model2)
anova(model2, model3) 

# anova comparison # 3.27e-16 ############# adding wave
model0 <- lmer(plsacpr ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls)
model1 <- lmer(plsacpr ~ behavior_management + wave + (1 | child_id), REML = FALSE, data = media_pls)
model2 <- lmer(plsacpr ~ behavior_management + wave + condition + (1 | child_id), REML = FALSE, data = media_pls)

summary(model2)
anova(model0, model1) 
anova(model1, model2) 


# anova comparison - add marital status - not sig anova didn't work
model1 <- lmer(plsacpr ~ behavior_management + wave + (1 | child_id), REML = FALSE, data = media_pls)
model2 <- lmer(plsacpr ~ behavior_management + wave + marital_status + (1 | child_id), REML = FALSE, data = media_pls)

summary(model2)
anova(model1, model2) 

# anova comparison - add bill_difficulty - 0.98
model1 <- lmer(plsacpr ~ behavior_management + wave + (1 | child_id), REML = FALSE, data = media_pls)
model2 <- lmer(plsacpr ~ behavior_management + wave + bill_difficulty + (1 | child_id), REML = FALSE, data = media_pls)

summary(model2)
anova(model1, model2) 

# anova comparison - add assistance - 0.987
model1 <- lmer(plsacpr ~ behavior_management + wave + (1 | child_id), REML = FALSE, data = media_pls)
model2 <- lmer(plsacpr ~ behavior_management + wave + assistance + (1 | child_id), REML = FALSE, data = media_pls)

summary(model2)
anova(model1, model2) 

# anova comparison # 2.2e-16 ############# adding wave
model0 <- lmer(plsecpr ~ behavior_management:father + wave + behavior_management:wave + (1 | child_id), REML = FALSE, data = media_pls)
model1 <- lmer(plsecpr ~ behavior_management:father + wave + (1 | child_id), REML = FALSE, data = media_pls)

summary(model0)
anova(model1, model0) 

# anova comparison # 0.3409 --- adding condition
model0 <- lmer(plspr ~ behavior_management + wave + (1 | child_id), REML = FALSE, data = media_pls)
model1 <- lmer(plspr ~ behavior_management + wave + condition + (1 | child_id), REML = FALSE, data = media_pls)
model2 <- lmer(plsacpr ~ behavior_management + wave + condition + (1 | child_id), REML = FALSE, data = media_pls)
model3 <- lmer(plsecpr ~ behavior_management + wave + condition + (1 | child_id), REML = FALSE, data = media_pls)
model4 <- lmer(plspr ~ behavior_management + wave + condition + father + (1 | child_id), REML = FALSE, data = media_pls)
model5 <- lmer(plspr ~ behavior_management:father + wave + condition + (1 | child_id), REML = FALSE, data = media_pls)



summary(model1)
summary(model2)
summary(model3)
summary(model4)
summary(model5)

anova(model0, model1)


# anova comparison # 0.3409 --- adding condition
model0 <- lmer(plspr ~ condition + (1 | child_id), REML = FALSE, data = media_pls)
model1 <- lmer(plspr ~ behavior_management + wave + condition + (1 | child_id), REML = FALSE, data = media_pls)

summary(model0)
anova(model0, model1)

# data set exploration
media_pls %>% 
  select(par_id, child_id, behavior_management, condition, father) %>%
  arrange(child_id)


glimpse(media)

media %>%
  group_by(child_id)

glimpse(bit)

bit %>%
  group_by(child_id)
```

## Signifant base models

```{r}
pls <- readRDS("../data/pls_long_rank.dta")
bit_mother <- readRDS("../data/BIT_long_mother.dta")
bit_father <- readRDS("../data/BIT_long_father.dta")
bit <- readRDS("../data/BIT_long_par.dta")
demo <- readRDS("../data/demography.dta")
media <- readRDS("../data/media_long.dta")
grouping <- readRDS("../data/grouping_data.dta")

demo <- demo %>% 
  transmute(par_id, child_id, 
            bill_difficulty = as.factor(bill_difficulty),
            marital_status = as.factor(marital_status),
            assistance,
            father)

#library(naniar)
#vis_miss(demo)

pls <- pls %>%
  mutate(par_id = as.character(par_id),
         child_id = as.character(child_id))

media_pls <- media %>%
  full_join(bit, by = c("child_id", "wave")) %>% 
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(grouping, by = c("child_id")) %>%
  inner_join(demo, by = c("child_id", "par_id")) 

media_pls_mother <- media %>%
  full_join(bit, by = c("child_id", "wave")) %>% 
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(grouping, by = c("child_id")) %>%
  inner_join(demo, by = c("child_id", "par_id")) %>%
  filter(par_id < 30000)

media_pls_father <- media %>%
  full_join(bit, by = c("child_id", "wave")) %>% 
  full_join(pls, by = c("par_id", "child_id", "wave")) %>%
  inner_join(grouping, by = c("child_id")) %>%
  inner_join(demo, by = c("child_id", "par_id")) %>%
  filter(par_id >= 30000)
 

# plspr significant models found
model <- lmer(plspr ~ behavior_management + wave + (1 | child_id), REML = FALSE, data = media_pls_mother)

# plsacpr significant models found
model0 <- lmer(plsacpr ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls)
model1 <- lmer(plsacpr ~ behavior_management + wave + (1 | child_id), REML = FALSE, data = media_pls)
model2 <- lmer(plsacpr ~ behavior_management + wave + condition + (1 | child_id), REML = FALSE, data = media_pls)

# plsecpr significant models found
model0 <- lmer(plsecpr ~ behavior_management + (1 | child_id), REML = FALSE, data = media_pls)
model1 <- lmer(plsecpr ~ behavior_management + wave + (1 | child_id), REML = FALSE, data = media_pls)
model2 <- lmer(plsecpr ~ behavior_management + wave + condition + (1 | child_id), REML = FALSE, data = media_pls)

# final significant found before we got tired
model <- lmer(plspr ~ behavior_management:father:wave + condition + (1 | child_id), REML = FALSE, data = media_pls)
model <- lmer(plsacpr ~ behavior_management:father:wave + condition + (1 | child_id), REML = FALSE, data = media_pls)
model <- lmer(plsecpr ~ behavior_management:father:wave + condition + (1 | child_id), REML = FALSE, data = media_pls)

anova(model, model1)
summary(model)
```

## Data for lmer assumption checking

```{r}
pls <- readRDS("../data/pls_long_rank.dta")
grouping <- readRDS("../data/grouping_data.dta")
media <- readRDS("../data/media_long.dta") %>% glimpse()

pls <- pls %>% 
  mutate(child_id = as.character(child_id))

pls_cond <- pls %>% 
  inner_join(grouping, by = c("child_id"))

bm <- media %>% 
  select(child_id, par_id, behavior_management, wave)

bm_cond <- media %>%
  inner_join(grouping, by = c("child_id")) %>%
  select(child_id, par_id, behavior_management, condition)

# pls by wave
pls_w1 <- pls %>% 
  filter(wave == 1)
pls_w4 <- pls %>%
  filter(wave == 4)
pls_w6 <- pls %>% 
  filter(wave == 6)


# pls by condition
pls_cond_1 <- pls_cond %>%
  filter(condition == 1)
pls_cond_2 <- pls_cond %>%
  filter(condition == 2)
pls_cond_3 <- pls_cond %>%
  filter(condition == 3)
pls_cond_4 <- pls_cond %>%
  filter(condition == 4)


# behavior management by wave
bm_w1 <- bm %>%
  filter(wave == 1)
bm_w4 <- bm %>%
  filter(wave == 4)
bm_w6 <- bm %>%
  filter(wave == 6)

# behavior management by condition
bm_cond_1 <- bm_cond %>% 
  filter(condition == 1)
bm_cond_2 <- bm_cond %>% 
  filter(condition == 1)
bm_cond_3 <- bm_cond %>% 
  filter(condition == 1)
bm_cond_4 <- bm_cond %>% 
  filter(condition == 1)
```

